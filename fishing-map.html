<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perth Fishing Spots Map</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
        }
        
        .container {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        h1 {
            text-align: center;
            color: white;
            padding: 15px 20px;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            flex-shrink: 0;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            padding: 0 20px 20px 20px;
            overflow: hidden;
            min-height: 0;
        }
        
        .map-section {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        .fish-table-section {
            flex: 1;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }
        
        #map {
            flex: 1;
            border-radius: 10px;
            border: 2px solid #ddd;
            min-height: 0;
        }
        
        .banner-container {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            flex-shrink: 0;
        }
        
        .fish-list-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            min-height: 0;
        }
        
        .fish-list-container h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
            position: sticky;
            top: 0;
            background: white;
            padding: 10px 0;
            z-index: 10;
        }
        
        .fish-item {
            background: #f9f9f9;
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .fish-item:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }
        
        .fish-item-header {
            display: flex;
            align-items: center;
            padding: 12px;
            gap: 12px;
        }
        
        .fish-item-image {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #667eea;
            flex-shrink: 0;
        }
        
        .fish-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .fish-item-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 3px;
        }
        
        .fish-item-scientific {
            font-size: 0.8em;
            color: #888;
            font-style: italic;
            margin-bottom: 5px;
        }
        
        .fish-item-basic {
            color: #555;
            font-size: 0.85em;
            line-height: 1.3;
        }
        
        .fish-item-expand {
            font-size: 1.5em;
            color: #667eea;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }
        
        .fish-item.expanded .fish-item-expand {
            transform: rotate(180deg);
        }
        
        .fish-item-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            padding: 0 12px;
        }
        
        .fish-item.expanded .fish-item-details {
            max-height: 2000px;
            padding: 0 12px 12px 12px;
        }
        
        .fish-detail-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }
        
        .fish-detail-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
            font-size: 0.95em;
        }
        
        .fish-detail-content {
            color: #555;
            line-height: 1.5;
            font-size: 0.9em;
        }
        
        .fish-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 5px;
        }
        
        .detail-item {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 5px;
        }
        
        .detail-label {
            font-weight: bold;
            color: #667eea;
            font-size: 0.85em;
        }
        
        .detail-value {
            color: #555;
            font-size: 0.85em;
        }
        
        .category-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            background: #667eea;
            color: white;
            margin-right: 5px;
        }
        
        .location-info {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .location-name {
            font-weight: bold;
            color: #667eea;
            font-size: 1.1em;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .map-section, .fish-table-section {
                flex: none;
                height: 45vh;
            }
            
            .banner-container {
                height: 150px;
            }
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
                padding: 10px;
            }
            
            .banner-container {
                height: 120px;
            }
            
            .fish-item-header {
                padding: 10px;
            }
            
            .fish-item-image {
                width: 60px;
                height: 60px;
            }
        }
        
        /* Custom scrollbar */
        .fish-list-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .fish-list-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .fish-list-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .fish-list-container::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé£ Perth Fishing Spots Map & Marine Species Guide</h1>
        
        <div class="main-content">
            <div class="map-section">
                <div id="map"></div>
            </div>
            
            <div class="fish-table-section">
                <div class="banner-container">
                    <div id="landscape-banner"></div>
                </div>
                <div class="fish-list-container" id="fish-list">
                    <!-- Fish species list will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Tide Harmonic Module -->
    <script type="module">
        import * as TideModule from './tide-harmonic.js';
        import { marineSpeciesDatabase, locationTypes, getSpeciesForLocation } from './marine-species.js';
        import { fishingSpots, getWeatherData, getMarineData, calculateLandscapeData, getTideStateInfo, getLandscapeType } from './fishing-map-app.js';
        
        window.TideModule = TideModule;
        window.marineSpeciesDatabase = marineSpeciesDatabase;
        window.locationTypes = locationTypes;
        window.getSpeciesForLocation = getSpeciesForLocation;
        window.fishingSpots = fishingSpots;
        window.getWeatherData = getWeatherData;
        window.getMarineData = getMarineData;
        window.calculateLandscapeData = calculateLandscapeData;
        window.getTideStateInfo = getTideStateInfo;
        window.getLandscapeType = getLandscapeType;
    </script>
    
    <!-- FishingLandscape Component -->
    <script type="text/babel" src="./animations/FishingLandscape.jsx"></script>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Main App Component
        function FishingMapApp() {
            const [selectedLocation, setSelectedLocation] = useState(null);
            const [landscapeData, setLandscapeData] = useState({
                time: 14,
                tide: 50,
                windSpeed: 15,
                windDir: 90,
                rain: 0,
                clouds: 20,
                moonPhase: 0.25,
                waveHeight: 0.5,
                temperature: 20
            });
            const [tideStats, setTideStats] = useState({
                status: 'Mid',
                arrow: '-',
                color: 'white',
                flow: 0
            });
            const [filteredSpecies, setFilteredSpecies] = useState(window.marineSpeciesDatabase || []);
            const [expandedSpecies, setExpandedSpecies] = useState(null);
            const [landscapeType, setLandscapeType] = useState('beach');
            
            // Load tide stations on mount
            useEffect(() => {
                if (window.TideModule) {
                    window.TideModule.loadStations('./stations.json').catch(console.error);
                }
            }, []);
            
            // Update landscape when location changes
            useEffect(() => {
                if (selectedLocation) {
                    updateLocationData(selectedLocation);
                }
            }, [selectedLocation]);
            
            async function updateLocationData(location) {
                try {
                    // Get weather and marine data
                    const weatherData = await window.getWeatherData(location.lat, location.lng);
                    const marineData = await window.getMarineData(location.lat, location.lng);
                    
                    // Get tide data
                    let tideData = { heightPercent: 50, movement: 0 };
                    if (window.TideModule && location.stationId) {
                        const station = window.TideModule.findStation(location.stationId);
                        if (station) {
                            const now = new Date();
                            const height = window.TideModule.predictTideHeight(station, now);
                            const movement = window.TideModule.calculateTideMovement(station, now);
                            
                            // Normalize height to percentage (assuming range of -0.5 to 1.5m)
                            const minHeight = -0.5;
                            const maxHeight = 1.5;
                            const heightPercent = ((height - minHeight) / (maxHeight - minHeight)) * 100;
                            
                            tideData = {
                                heightPercent: Math.max(0, Math.min(100, heightPercent)),
                                movement: movement
                            };
                            
                            const tideInfo = window.getTideStateInfo(movement);
                            setTideStats({
                                status: heightPercent > 80 ? 'High' : heightPercent < 20 ? 'Low' : 'Mid',
                                ...tideInfo
                            });
                        }
                    }
                    
                    // Calculate landscape data
                    const newLandscapeData = window.calculateLandscapeData(weatherData, marineData, tideData);
                    setLandscapeData(newLandscapeData);
                    
                    // Set landscape type
                    const newLandscapeType = window.getLandscapeType(location.locationType);
                    setLandscapeType(newLandscapeType);
                    
                    // Filter species for this location
                    const species = window.getSpeciesForLocation(location.region);
                    setFilteredSpecies(species);
                    
                } catch (error) {
                    console.error('Error updating location data:', error);
                }
            }
            
            function toggleSpecies(speciesId) {
                setExpandedSpecies(expandedSpecies === speciesId ? null : speciesId);
            }
            
            return (
                <>
                    <FishListDisplay 
                        species={filteredSpecies}
                        expandedSpecies={expandedSpecies}
                        toggleSpecies={toggleSpecies}
                        selectedLocation={selectedLocation}
                    />
                </>
            );
        }
        
        // Fish List Display Component
        function FishListDisplay({ species, expandedSpecies, toggleSpecies, selectedLocation }) {
            return (
                <div>
                    {selectedLocation && (
                        <div className="location-info">
                            <div className="location-name">{selectedLocation.name}</div>
                            <div style={{ fontSize: '0.9em', color: '#666', marginTop: '5px' }}>
                                {selectedLocation.region} - {species.length} species available
                            </div>
                        </div>
                    )}
                    
                    <h2>{selectedLocation ? 'Species at this Location' : 'All Perth Marine Species'}</h2>
                    
                    {species.length === 0 && (
                        <div style={{ textAlign: 'center', padding: '40px', color: '#888' }}>
                            <p>Click on a location on the map to see species available there.</p>
                        </div>
                    )}
                    
                    {species.map(s => (
                        <div 
                            key={s.id} 
                            className={`fish-item ${expandedSpecies === s.id ? 'expanded' : ''}`}
                            onClick={() => toggleSpecies(s.id)}
                        >
                            <div className="fish-item-header">
                                <img src={s.image} alt={s.name} className="fish-item-image" />
                                <div className="fish-item-info">
                                    <div className="fish-item-name">
                                        {s.name}
                                        <span className="category-badge">{s.category}</span>
                                    </div>
                                    <div className="fish-item-scientific">{s.scientificName}</div>
                                    <div className="fish-item-basic">{s.basicInfo}</div>
                                </div>
                                <div className="fish-item-expand">‚ñº</div>
                            </div>
                            
                            <div className="fish-item-details">
                                <div className="fish-detail-section">
                                    <div className="fish-detail-title">üìç Best Locations</div>
                                    <div className="fish-detail-content">{s.locations.join(', ')}</div>
                                </div>
                                
                                <div className="fish-detail-section">
                                    <div className="fish-detail-title">‚è∞ Best Fishing Times</div>
                                    <div className="fish-detail-grid">
                                        <div className="detail-item">
                                            <div className="detail-label">Time of Day</div>
                                            <div className="detail-value">{s.bestTime}</div>
                                        </div>
                                        <div className="detail-item">
                                            <div className="detail-label">Tide</div>
                                            <div className="detail-value">{s.bestTide}</div>
                                        </div>
                                        <div className="detail-item">
                                            <div className="detail-label">Season</div>
                                            <div className="detail-value">{s.bestSeason}</div>
                                        </div>
                                        <div className="detail-item">
                                            <div className="detail-label">Weather</div>
                                            <div className="detail-value">{s.bestTimes?.weather || 'Variable'}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                {s.rig && (
                                    <div className="fish-detail-section">
                                        <div className="fish-detail-title">üé£ Rig Setup</div>
                                        <div className="fish-detail-grid">
                                            <div className="detail-item">
                                                <div className="detail-label">Rod & Line</div>
                                                <div className="detail-value">{s.rig.description}</div>
                                            </div>
                                            {s.rig.hookSize && (
                                                <div className="detail-item">
                                                    <div className="detail-label">Hook Size</div>
                                                    <div className="detail-value">{s.rig.hookSize}</div>
                                                </div>
                                            )}
                                            {s.rig.sinkerWeight && (
                                                <div className="detail-item">
                                                    <div className="detail-label">Sinker</div>
                                                    <div className="detail-value">{s.rig.sinkerWeight}</div>
                                                </div>
                                            )}
                                            {s.rig.leader && (
                                                <div className="detail-item">
                                                    <div className="detail-label">Leader</div>
                                                    <div className="detail-value">{s.rig.leader}</div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                                
                                {s.bait && (
                                    <div className="fish-detail-section">
                                        <div className="fish-detail-title">ü¶ê Bait & Lures</div>
                                        {s.bait.primary && s.bait.primary.length > 0 && (
                                            <div className="detail-item" style={{ marginBottom: '8px' }}>
                                                <div className="detail-label">Bait</div>
                                                <div className="detail-value">{s.bait.primary.join(', ')}</div>
                                            </div>
                                        )}
                                        {s.bait.lures && s.bait.lures.length > 0 && (
                                            <div className="detail-item">
                                                <div className="detail-label">Lures</div>
                                                <div className="detail-value">{s.bait.lures.join(', ')}</div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                
                                {s.tactics && (
                                    <div className="fish-detail-section">
                                        <div className="fish-detail-title">üí° Tactics & Tips</div>
                                        <div className="fish-detail-content">{s.tactics}</div>
                                    </div>
                                )}
                            </div>
                        </div>
                    ))}
                </div>
            );
        }
        
        // Initialize map
        const map = L.map('map').setView([-31.9505, 115.8605], 10);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Custom marker icon
        const fishingIcon = L.icon({
            iconUrl: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg width="30" height="45" viewBox="0 0 30 45" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 0 L30 45 L15 40 L0 45 Z" fill="#667eea" stroke="#ffffff" stroke-width="2"/>
                    <text x="15" y="25" font-size="18" text-anchor="middle" fill="white">ÔøΩÔøΩ</text>
                </svg>
            `),
            iconSize: [30, 45],
            iconAnchor: [15, 45],
            popupAnchor: [0, -45]
        });
        
        // Render React app
        const fishListRoot = ReactDOM.createRoot(document.getElementById('fish-list'));
        const landscapeBannerRoot = ReactDOM.createRoot(document.getElementById('landscape-banner'));
        
        let currentAppState = {
            selectedLocation: null,
            landscapeData: {
                time: 14,
                tide: 50,
                windSpeed: 15,
                windDir: 90,
                rain: 0,
                clouds: 20,
                moonPhase: 0.25
            },
            tideStats: {
                status: 'Mid',
                arrow: '-',
                color: 'white',
                flow: 0
            },
            landscapeType: 'beach'
        };
        
        function updateApp() {
            fishListRoot.render(<FishingMapApp />);
            
            // Render landscape banner
            if (window.Landscape) {
                landscapeBannerRoot.render(
                    <window.Landscape 
                        data={currentAppState.landscapeData}
                        tideStats={currentAppState.tideStats}
                        landscapeType={currentAppState.landscapeType}
                    />
                );
            }
        }
        
        // Add markers for each fishing spot
        window.fishingSpots.forEach(spot => {
            const marker = L.marker([spot.lat, spot.lng], { icon: fishingIcon })
                .addTo(map);
            
            marker.on('click', async () => {
                currentAppState.selectedLocation = spot;
                updateApp();
                
                // Fetch and update data for this location
                try {
                    const weatherData = await window.getWeatherData(spot.lat, spot.lng);
                    const marineData = await window.getMarineData(spot.lat, spot.lng);
                    
                    let tideData = { heightPercent: 50, movement: 0 };
                    if (window.TideModule && spot.stationId) {
                        const station = window.TideModule.findStation(spot.stationId);
                        if (station) {
                            const now = new Date();
                            const height = window.TideModule.predictTideHeight(station, now);
                            const movement = window.TideModule.calculateTideMovement(station, now);
                            
                            const minHeight = -0.5;
                            const maxHeight = 1.5;
                            const heightPercent = ((height - minHeight) / (maxHeight - minHeight)) * 100;
                            
                            tideData = {
                                heightPercent: Math.max(0, Math.min(100, heightPercent)),
                                movement: movement
                            };
                            
                            const tideInfo = window.getTideStateInfo(movement);
                            currentAppState.tideStats = {
                                status: heightPercent > 80 ? 'High' : heightPercent < 20 ? 'Low' : 'Mid',
                                ...tideInfo
                            };
                        }
                    }
                    
                    currentAppState.landscapeData = window.calculateLandscapeData(weatherData, marineData, tideData);
                    currentAppState.landscapeType = window.getLandscapeType(spot.locationType);
                    
                    updateApp();
                } catch (error) {
                    console.error('Error updating location:', error);
                }
            });
            
            marker.bindTooltip(spot.name, {
                permanent: false,
                direction: 'top'
            });
        });
        
        L.control.scale({ imperial: false, metric: true }).addTo(map);
        
        // Initial render
        updateApp();
    </script>
</body>
</html>
